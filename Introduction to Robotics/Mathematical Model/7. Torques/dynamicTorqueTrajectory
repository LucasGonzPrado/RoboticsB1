function Tau = dynamicTorqueTrajectory(robotDyn, Q, Qd, Qdd)
% DYNAMICTORQUETRAJECTORY  Joint torques along a trajectory using RNE.
%
%   Tau = dynamicTorqueTrajectory(robotDyn, Q, Qd, Qdd)
%
%   Inputs:
%     robotDyn : SerialLink robot (with dynamics + gravity set)
%     Q        : n x N joint positions
%     Qd       : n x N joint velocities
%     Qdd      : n x N joint accelerations
%
%   Output:
%     Tau      : N x n matrix, row k = torque at time t_k [N*m]

    [n, N] = size(Q);

    if ~isequal(size(Qd), [n, N]) || ~isequal(size(Qdd), [n, N])
        error('Q, Qd, Qdd must all be n x N with the same size.');
    end

    Tau = zeros(N, n);

    for k = 1:N
        q   = Q(:,k).';   % 1 x n
        qd  = Qd(:,k).';  % 1 x n
        qdd = Qdd(:,k).'; % 1 x n

        % Use robotDyn.gravity property (already set outside)
        tau = robotDyn.rne(q, qd, qdd);   % 1 x n
        Tau(k,:) = tau;
    end
end
